package com.madslee.fixercache

import io.javalin.Javalin
import io.javalin.apibuilder.ApiBuilder.get
import org.assertj.core.api.Assertions.assertThat
import org.junit.jupiter.api.BeforeAll
import org.junit.jupiter.api.Test
import org.junit.jupiter.api.TestInstance

@TestInstance(TestInstance.Lifecycle.PER_CLASS)
class FixerClientTest {

    @BeforeAll
    fun init() {
        Environment.set("fixerBaseUrl", "http://localhost:9090/")
        Environment.set("fixerAccessKey", "accessKey")
        startMockServer()
    }

    @Test
    fun `get latest currency rates from base`() {
        val base = "EUR"
        val currencyRateInformation = getLatestCurrencyRates(base)
        assertThat(currencyRateInformation).isNotNull
        assertThat(currencyRateInformation.rates).isNotEmpty
    }

    private fun startMockServer() {
        Javalin.create().start(9090).routes {
            get("*") { context ->
                context.result(response)
            }
        }
    }

    private val response = """{
    "success": true,
    "timestamp": 1611339187,
    "base": "EUR",
    "date": "2021-01-22",
    "rates": {
        "AED": 4.469154,
        "AFN": 93.872356,
        "ALL": 123.682604,
        "AMD": 630.809687,
        "ANG": 2.185054,
        "AOA": 799.085498,
        "ARS": 105.326427,
        "AUD": 1.577259,
        "AWG": 2.190141,
        "AZN": 2.073297,
        "BAM": 1.955163,
        "BBD": 2.457861,
        "BDT": 103.22308,
        "BGN": 1.954468,
        "BHD": 0.458673,
        "BIF": 2373.869188,
        "BMD": 1.216745,
        "BND": 1.615649,
        "BOB": 8.38124,
        "BRL": 6.653044,
        "BSD": 1.217285,
        "BTC": 3.7496909e-5,
        "BTN": 88.880874,
        "BWP": 13.355243,
        "BYN": 3.103241,
        "BYR": 23848.198913,
        "BZD": 2.453783,
        "CAD": 1.549701,
        "CDF": 2396.98778,
        "CHF": 1.07789,
        "CLF": 0.032075,
        "CLP": 885.186633,
        "CNY": 7.886823,
        "COP": 4292.322948,
        "CRC": 744.056126,
        "CUC": 1.216745,
        "CUP": 32.243738,
        "CVE": 110.724218,
        "CZK": 26.107456,
        "DJF": 216.240372,
        "DKK": 7.439604,
        "DOP": 70.697604,
        "DZD": 161.509863,
        "EGP": 19.134169,
        "ERN": 18.251608,
        "ETB": 47.842884,
        "EUR": 1,
        "FJD": 2.499243,
        "FKP": 0.889514,
        "GBP": 0.889495,
        "GEL": 4.027901,
        "GGP": 0.889514,
        "GHS": 7.111922,
        "GIP": 0.889514,
        "GMD": 62.667048,
        "GNF": 12370.041127,
        "GTQ": 9.470769,
        "GYD": 254.683101,
        "HKD": 9.432511,
        "HNL": 29.518703,
        "HRK": 7.567671,
        "HTG": 89.41949,
        "HUF": 357.3706,
        "IDR": 17156.10228,
        "ILS": 3.981924,
        "IMP": 0.889514,
        "INR": 88.827058,
        "IQD": 1779.489332,
        "IRR": 51231.042023,
        "ISK": 156.997057,
        "JEP": 0.889514,
        "JMD": 176.761688,
        "JOD": 0.86272,
        "JPY": 126.317631,
        "KES": 133.903238,
        "KGS": 103.139937,
        "KHR": 4933.900763,
        "KMF": 492.299583,
        "KPW": 1095.141515,
        "KRW": 1345.482579,
        "KWD": 0.368297,
        "KYD": 1.014454,
        "KZT": 512.196285,
        "LAK": 11346.146081,
        "LBP": 1849.452585,
        "LKR": 240.725963,
        "LRD": 207.459588,
        "LSL": 18.117795,
        "LTL": 3.592732,
        "LVL": 0.735997,
        "LYD": 5.420646,
        "MAD": 10.87653,
        "MDL": 21.291035,
        "MGA": 4595.645692,
        "MKD": 61.639562,
        "MMK": 1621.476547,
        "MNT": 3480.965257,
        "MOP": 9.720183,
        "MRO": 434.3777,
        "MUR": 48.353901,
        "MVR": 18.750498,
        "MWK": 942.977673,
        "MXN": 24.303875,
        "MYR": 4.919347,
        "MZN": 91.395836,
        "NAD": 18.11779,
        "NGN": 464.192692,
        "NIO": 42.647365,
        "NOK": 10.342113,
        "NPR": 142.209478,
        "NZD": 1.695406,
        "OMR": 0.468425,
        "PAB": 1.217285,
        "PEN": 4.422264,
        "PGK": 4.295566,
        "PHP": 58.500488,
        "PKR": 195.470515,
        "PLN": 4.539846,
        "PYG": 8423.026035,
        "QAR": 4.429864,
        "RON": 4.875866,
        "RSD": 118.51544,
        "RUB": 91.584754,
        "RWF": 1198.49367,
        "SAR": 4.565028,
        "SBD": 9.696563,
        "SCR": 25.802284,
        "SDG": 67.255618,
        "SEK": 10.090538,
        "SGD": 1.616738,
        "SHP": 0.889514,
        "SLL": 12384.641844,
        "SOS": 710.5794,
        "SRD": 17.221853,
        "STD": 25350.712525,
        "SVC": 10.651453,
        "SYP": 623.999507,
        "SZL": 18.142116,
        "THB": 36.501742,
        "TJS": 13.872037,
        "TMT": 4.258607,
        "TND": 3.287041,
        "TOP": 2.784095,
        "TRY": 9.019285,
        "TTD": 8.274577,
        "TWD": 34.045783,
        "TZS": 2821.631698,
        "UAH": 34.2894,
        "UGX": 4488.268587,
        "USD": 1.216745,
        "UYU": 51.267507,
        "UZS": 12775.821254,
        "VEF": 12.152244,
        "VND": 28072.128634,
        "VUV": 131.73582,
        "WST": 3.066942,
        "XAF": 655.733262,
        "XAG": 0.047756,
        "XAU": 0.000656,
        "XCD": 3.288314,
        "XDR": 0.843912,
        "XOF": 656.438225,
        "XPF": 119.788973,
        "YER": 304.677286,
        "ZAR": 18.385319,
        "ZMK": 10952.168048,
        "ZMW": 25.980735,
        "ZWL": 391.792065
        }
    }"""
}